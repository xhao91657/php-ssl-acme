name: Upload APKs in repo root to Release
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  upload-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show APKs at repo root
        run: |
          echo "Listing APKs in repository root:"
          ls -la ./*.apk || true

      - name: Fail if no APK found
        run: |
          shopt -s nullglob
          apks=(./*.apk)
          if [ ${#apks[@]} -eq 0 ]; then
            echo "No .apk files found in repository root. Aborting."
            exit 1
          fi
        shell: bash

      - name: Compute release tag/name
        id: vars
        run: |
          # If GITHUB_REF is a tag (refs/tags/...), use the tag name; otherwise fallback to manual-<run_id>
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
          else
            tag="manual-${GITHUB_RUN_ID}"
          fi
          echo "Computed tag: $tag"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          release_name: ${{ steps.vars.outputs.tag }}
          draft: false
          prerelease: false

      - name: Upload all APKs in repo root to the Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
        run: |
          # Remove the template part {?name,label} from upload_url if present
          upload_url="${UPLOAD_URL%\{*}"
          echo "Release upload URL: $upload_url"

          shopt -s nullglob
          for f in ./*.apk; do
            name=$(basename "$f")
            echo "Uploading $f as $name ..."
            curl --fail -sS -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Content-Type: application/vnd.android.package-archive" \
              --data-binary @"$f" \
              "${upload_url}?name=${name}"
            echo "Uploaded $name"
          done
        shell: bash
