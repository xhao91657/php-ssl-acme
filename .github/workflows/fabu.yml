# Publish top-level files in repository root as release assets (one asset per file)
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish-root-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List root files
        run: |
          echo "Root files (top-level):"
          ls -la .

      - name: Create release and upload root files as assets
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            // 注意：不要在这里重新 require('@actions/core')，github-script 已经注入了 core
            const { owner, repo } = context.repo;
            const workspace = process.env.GITHUB_WORKSPACE || '.';

            // Determine tag name: use pushed tag if present, otherwise manual-<run_number>
            const ref = context.ref || '';
            const tagName = ref.startsWith('refs/tags/') ? ref.replace('refs/tags/', '') : `manual-${process.env.GITHUB_RUN_NUMBER}`;
            const releaseName = `Release ${tagName}`;

            core.info(`Using tag: ${tagName}`);
            core.info(`Workspace: ${workspace}`);

            // Read top-level entries and keep only files (do NOT recurse)
            const entries = fs.readdirSync(workspace);
            const files = entries.filter(name => {
              const full = path.join(workspace, name);
              try {
                return fs.statSync(full).isFile();
              } catch (e) {
                return false;
              }
            });

            if (files.length === 0) {
              core.info('No top-level files found to upload. Place files at the repository root and re-run.');
              return;
            }

            // create or get release for tagName
            let release;
            try {
              const existing = await github.rest.repos.getReleaseByTag({ owner, repo, tag: tagName });
              release = existing.data;
              core.info(`Found existing release id=${release.id} for tag ${tagName}`);
            } catch (err) {
              core.info(`No existing release for tag ${tagName}, creating one.`);
              const created = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tagName,
                name: releaseName,
                body: `Release created by workflow for top-level files`,
                draft: false,
                prerelease: false
              });
              release = created.data;
              core.info(`Created release id=${release.id}`);
            }

            // Upload each top-level file as an individual asset
            for (const name of files) {
              const full = path.join(workspace, name);
              const data = fs.readFileSync(full);
              core.info(`Uploading ${name} (${data.length} bytes) ...`);
              await github.rest.repos.uploadReleaseAsset({
                owner,
                repo,
                release_id: release.id,
                name: name,
                data,
                headers: {
                  'content-type': 'application/octet-stream',
                  'content-length': data.length
                }
              });
              core.info(`Uploaded ${name}`);
            }

            core.info('All top-level files uploaded. Check the Releases page and the Assets list.');
